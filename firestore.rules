rules_version = '2';

/**
 * Firestore Security Rules - Old Texas BBQ CRM
 *
 * Basado en matriz de permisos documentada en docs/MATRIZ_PERMISOS.md
 *
 * Roles del sistema:
 * - admin: Acceso total (100%)
 * - encargado: Gestión operativa completa (95%)
 * - cajera: Gestión de pedidos y caja (40%)
 * - cocina: Visualización y actualización de pedidos (25%)
 * - repartidor: Ver y actualizar sus entregas (20%)
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // FUNCIONES HELPER
    // ========================================================================

    /**
     * Verificar si el usuario está autenticado
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Obtener datos del usuario actual desde Firestore
     */
    function getUserData() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
    }

    /**
     * Verificar rol específico del usuario
     */
    function hasRole(role) {
      return isAuthenticated() && getUserData().rol == role;
    }

    /**
     * Verificar si el usuario tiene uno de los roles especificados
     */
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().rol in roles;
    }

    /**
     * Verificar si el usuario está activo en el sistema
     */
    function isActive() {
      return isAuthenticated() && getUserData().activo == true;
    }

    /**
     * Verificar si es administrador
     */
    function isAdmin() {
      return hasRole('admin');
    }

    /**
     * Verificar si es manager (admin o encargado)
     */
    function isManager() {
      return hasAnyRole(['encargado', 'admin']);
    }

    /**
     * Verificar si es personal operativo (cajera, cocina, repartidor)
     */
    function isStaff() {
      return hasAnyRole(['cajera', 'cocina', 'repartidor']);
    }

    // ========================================================================
    // COLECCIÓN: USUARIOS
    // ========================================================================

    match /usuarios/{userId} {
      // LEER
      allow read: if isAuthenticated() && (
        // Usuario puede leer su propio perfil
        request.auth.uid == userId ||
        // Managers pueden leer todos los usuarios
        isManager()
      );

      // CREAR
      allow create: if (
        // Managers pueden crear usuarios
        (isManager() && isActive()) ||
        // Usuario recién creado puede crear su propio documento inicial
        // (necesario para registro de repartidores desde admin)
        (isAuthenticated() && request.auth.uid == userId)
      );

      // ACTUALIZAR
      allow update: if isActive() && (
        // Usuario puede actualizar su perfil (excepto rol y activo)
        (request.auth.uid == userId &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['rol', 'activo'])) ||
        // Managers pueden actualizar cualquier usuario
        isManager()
      );

      // ELIMINAR
      // Solo admin puede eliminar usuarios
      allow delete: if isAdmin();
    }

    // ========================================================================
    // COLECCIÓN: PEDIDOS
    // ========================================================================

    match /pedidos/{pedidoId} {
      // LEER
      allow read: if (
        // Managers ven todos los pedidos
        (isAuthenticated() && isActive() && isManager()) ||

        // Cajeras ven todos los pedidos (necesario para gestionar)
        (isAuthenticated() && isActive() && hasRole('cajera')) ||

        // Cocina ve todos los pedidos (necesario para cocinar)
        (isAuthenticated() && isActive() && hasRole('cocina')) ||

        // Repartidores ven solo sus pedidos asignados
        (isAuthenticated() && isActive() && hasRole('repartidor') &&
         resource.data.reparto.repartidorId == request.auth.uid)
      );

      // CREAR
      allow create: if (
        // Managers y cajeras pueden crear pedidos
        (isActive() && hasAnyRole(['admin', 'encargado', 'cajera']) &&
         request.resource.data.creadoPor == request.auth.uid) ||

        // Pedidos públicos desde formulario web (sin autenticación)
        (request.resource.data.canal == 'web' &&
         request.resource.data.creadoPor == 'sistema-web' &&
         request.resource.data.estado == 'pendiente')
      );

      // ACTUALIZAR
      allow update: if isActive() && (
        // Managers pueden actualizar todo
        isManager() ||

        // Cajeras pueden actualizar pedidos que ellas crearon
        (hasRole('cajera') && resource.data.creadoPor == request.auth.uid) ||

        // Cocina puede actualizar solo el estado del pedido
        (hasRole('cocina') &&
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['estado', 'horaInicioCocina', 'horaListo', 'fechaActualizacion']) &&
         request.resource.data.estado in ['en_preparacion', 'listo']) ||

        // Repartidor puede actualizar solo su información de reparto
        (hasRole('repartidor') &&
         resource.data.reparto.repartidorId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['estado', 'reparto', 'horaEntrega', 'fechaActualizacion']) &&
         request.resource.data.estado in ['en_reparto', 'entregado'])
      );

      // ELIMINAR
      // Solo admin puede eliminar pedidos
      allow delete: if isAdmin();
    }

    // ========================================================================
    // SUBCOLECCIÓN: ITEMS DE PEDIDO
    // ========================================================================

    match /pedidos/{pedidoId}/items/{itemId} {
      // LEER
      allow read: if (
        // Autenticados y activos pueden leer items
        (isAuthenticated() && isActive()) ||
        // Permitir lectura pública para validación de pedidos web
        true
      );

      // ESCRIBIR
      allow write: if (
        // Managers y cajeras pueden gestionar items
        (isAuthenticated() && isActive() && hasAnyRole(['admin', 'encargado', 'cajera'])) ||
        // Permitir escritura para pedidos web públicos
        true
      );
    }

    // ========================================================================
    // SUBCOLECCIÓN: HISTORIAL DE PEDIDO
    // ========================================================================

    match /pedidos/{pedidoId}/historial/{historialId} {
      // LEER
      allow read: if isAuthenticated() && isActive();

      // ESCRIBIR
      allow write: if (
        // Usuarios autenticados pueden crear historial
        (isAuthenticated() && isActive()) ||
        // Permitir escritura para pedidos web públicos
        true
      );
    }

    // ========================================================================
    // COLECCIÓN: PRODUCTOS
    // ========================================================================

    match /productos/{productoId} {
      // LEER
      allow read: if (
        // Autenticados activos ven todos los productos
        (isAuthenticated() && isActive()) ||
        // Público ve solo productos disponibles (para formulario web)
        (resource.data.disponible == true)
      );

      // CREAR
      allow create: if isManager() && isActive();

      // ACTUALIZAR
      allow update: if isManager() && isActive();

      // ELIMINAR
      allow delete: if isAdmin();
    }

    // ========================================================================
    // COLECCIÓN: CATEGORÍAS
    // ========================================================================

    match /categorias/{categoriaId} {
      // LEER
      allow read: if (
        // Autenticados activos pueden leer categorías
        (isAuthenticated() && isActive()) ||
        // Público puede leer categorías activas
        (resource.data.activa == true)
      );

      // CREAR
      allow create: if isManager() && isActive();

      // ACTUALIZAR
      allow update: if isManager() && isActive();

      // ELIMINAR
      allow delete: if isAdmin();
    }

    // ========================================================================
    // COLECCIÓN: REPARTIDORES
    // ========================================================================

    match /repartidores/{repartidorId} {
      // LEER
      allow read: if isAuthenticated() && isActive() && (
        // Managers ven todos los repartidores
        isManager() ||
        // Cajeras ven todos (para asignar pedidos)
        hasRole('cajera') ||
        // Repartidor ve solo su propio documento
        (hasRole('repartidor') && resource.data.usuarioId == request.auth.uid)
      );

      // CREAR
      allow create: if isManager() && isActive();

      // ACTUALIZAR
      allow update: if isActive() && (
        // Managers pueden actualizar cualquier repartidor
        isManager() ||
        // Repartidor puede actualizar solo su disponibilidad
        (hasRole('repartidor') &&
         resource.data.usuarioId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['disponible']))
      );

      // ELIMINAR
      allow delete: if isAdmin();
    }

    // ========================================================================
    // COLECCIÓN: TURNOS
    // ========================================================================

    match /turnos/{turnoId} {
      // LEER
      allow read: if isAuthenticated() && isActive();

      // CREAR
      allow create: if isActive() && (
        // Managers pueden crear turnos
        isManager() ||
        // Cajera puede crear su propio turno
        (hasRole('cajera') && request.resource.data.cajeroId == request.auth.uid)
      );

      // ACTUALIZAR
      allow update: if isActive() && (
        // Managers pueden actualizar cualquier turno
        isManager() ||
        // Cajera puede actualizar su turno activo (no cerrado)
        (hasRole('cajera') &&
         resource.data.cajeroId == request.auth.uid &&
         resource.data.estado == 'abierto')
      );

      // ELIMINAR
      allow delete: if isAdmin();
    }

    // ========================================================================
    // SUBCOLECCIÓN: TRANSACCIONES DE TURNO
    // ========================================================================

    match /turnos/{turnoId}/transacciones/{transaccionId} {
      // LEER
      allow read: if isAuthenticated() && isActive();

      // CREAR
      allow create: if isActive() && (
        isManager() ||
        hasRole('cajera')
      );

      // ACTUALIZAR/ELIMINAR
      allow update, delete: if isManager() && isActive();
    }

    // ========================================================================
    // COLECCIÓN: COLONIAS
    // ========================================================================

    match /colonias/{coloniaId} {
      // LEER
      allow read: if (
        // Autenticados activos ven todas las colonias
        (isAuthenticated() && isActive()) ||
        // Público ve solo colonias activas (para formulario web)
        (resource.data.activa == true)
      );

      // CREAR
      allow create: if isManager() && isActive();

      // ACTUALIZAR
      allow update: if isManager() && isActive();

      // ELIMINAR
      allow delete: if isAdmin();
    }

    // ========================================================================
    // COLECCIÓN: NOTIFICACIONES
    // ========================================================================

    match /notificaciones/{notifId} {
      // LEER
      allow read: if isAuthenticated() && isActive() && (
        // Usuario pertenece al rol destino
        getUserData().rol in resource.data.rol_destino ||
        // Usuario es el destinatario específico
        resource.data.usuario_destino == request.auth.uid ||
        // Managers ven todas las notificaciones
        isManager()
      );

      // CREAR
      allow create: if isManager() && isActive();

      // ACTUALIZAR
      allow update: if isAuthenticated() && isActive() && (
        // Usuario puede marcar como leída sus propias notificaciones
        (getUserData().rol in resource.data.rol_destino &&
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['leida', 'fechaLeida', 'leida_por'])) ||
        // Managers pueden actualizar cualquier notificación
        isManager()
      );

      // ELIMINAR
      allow delete: if isAdmin();
    }

    // ========================================================================
    // COLECCIÓN: CONFIGURACIÓN
    // ========================================================================

    match /configuracion/{configId} {
      // LEER
      allow read: if isAuthenticated() && isActive();

      // CREAR
      allow create: if isAdmin();

      // ACTUALIZAR
      allow update: if isManager() && isActive();

      // ELIMINAR
      allow delete: if isAdmin();
    }

    // ========================================================================
    // COLECCIÓN: NOTIFICACION_SETTINGS (Preferencias de usuario)
    // ========================================================================

    match /notificacion_settings/{userId} {
      // Cada usuario puede leer/escribir solo su propia configuración
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ========================================================================
    // COLECCIÓN: FCM_TOKENS (Deprecated - usar notificaciones in-app)
    // ========================================================================

    match /fcmTokens/{tokenId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // ========================================================================
    // REGLA POR DEFECTO: DENEGAR TODO LO NO ESPECIFICADO
    // ========================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
